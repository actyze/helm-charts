{{- if and .Values.services.trino.enabled .Values.trino.config.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dashboard.trino.fullname" . }}-config
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "dashboard.trino.labels" . | nindent 4 }}
data:
  config.properties: |
    coordinator=true
    node-scheduler.include-coordinator=true
    http-server.http.port=8080
    discovery.uri=http://localhost:8080
    node.environment={{ .Values.trino.environment }}
    node.id={{ .Values.trino.nodeId | default "ffffffff-ffff-ffff-ffff-ffffffffffff" }}
    {{- if .Values.trino.security.authentication.enabled }}
    # Authentication
    http-server.authentication.type=PASSWORD
    http-server.authentication.password.user-mapping.pattern=(.*)
    http-server.authentication.allow-insecure-over-http=true
    internal-communication.shared-secret={{ .Values.trino.security.authentication.internalSecret | default "default-change-in-production" }}
    {{- end }}
    {{- if .Values.trino.security.accessControl.enabled }}
    # Access Control
    access-control.config-files=/etc/trino/access-control.properties
    {{- end }}
    
  jvm.config: |
    -server
    -Xmx{{ .Values.trino.jvm.maxHeapSize | default "2G" }}
    -XX:InitialRAMPercentage=80
    -XX:MaxRAMPercentage=80
    -XX:G1HeapRegionSize=32M
    -XX:+ExplicitGCInvokesConcurrent
    -XX:+ExitOnOutOfMemoryError
    -XX:+HeapDumpOnOutOfMemoryError
    -XX:-OmitStackTraceInFastThrow
    -XX:ReservedCodeCacheSize=512M
    -XX:PerMethodRecompilationCutoff=10000
    -XX:PerBytecodeRecompilationCutoff=10000
    -Djdk.attach.allowAttachSelf=true
    -Djdk.nio.maxCachedBufferSize=2000000
    {{- if .Values.trino.jvm.additionalOptions }}
    {{- range .Values.trino.jvm.additionalOptions }}
    {{ . }}
    {{- end }}
    {{- end }}
    
  log.properties: |
    io.trino=INFO
    
  node.properties: |
    node.environment={{ .Values.trino.environment }}
    node.id={{ .Values.trino.nodeId | default "ffffffff-ffff-ffff-ffff-ffffffffffff" }}
    
  {{- if .Values.trino.catalogs }}
  {{- range $name, $config := .Values.trino.catalogs }}
  {{ $name }}.properties: |
    {{- range $key, $value := $config }}
    {{ $key }}={{ $value }}
    {{- end }}
  {{- end }}
  {{- end }}
  
  {{- if .Values.services.postgres.enabled }}
  postgres.properties: |
    connector.name=postgresql
    connection-url=jdbc:postgresql://{{ include "dashboard.fullname" . }}-postgres:5432/{{ .Values.postgres.database }}?sslmode=disable
    connection-user={{ .Values.secrets.postgres.username | default "dashboard_user" }}
    connection-password=${ENV:POSTGRES_PASSWORD}
  {{- end }}
  
  {{- if .Values.trino.security.accessControl.enabled }}
  access-control.properties: |
    access-control.name=file
    security.config-file=/etc/trino/rules.json
    security.refresh-period=1s
    
  rules.json: |
    {
      "catalogs": [
        {
          "user": ".*",
          "catalog": ".*",
          "allow": "read-only"
        }
      ]
    }
  {{- end }}
  
  {{- if .Values.trino.security.authentication.enabled }}
  password-authenticator.properties: |
    password-authenticator.name=file
    file.password-file=/etc/trino-auth/password.db
  {{- end }}
{{- end }}
