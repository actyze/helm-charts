{{- if .Values.services.schemaService.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "dashboard.fullname" . }}-schema-service
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "dashboard.labels" . | nindent 4 }}
    app.kubernetes.io/component: schema-service
spec:
  replicas: {{ .Values.schemaService.replicaCount }}
  selector:
    matchLabels:
      {{- include "dashboard.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: schema-service
  template:
    metadata:
      labels:
        {{- include "dashboard.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: schema-service
    spec:
      containers:
      - name: schema-service
        image: "{{ .Values.schemaService.image.repository }}:{{ .Values.schemaService.image.tag }}"
        imagePullPolicy: {{ .Values.schemaService.image.pullPolicy | default .Values.global.imagePullPolicy }}
        env:
        # Schema Service Authentication
        {{- if .Values.schemaService.env.schemaServiceKey }}
        - name: SCHEMA_SERVICE_KEY
          value: {{ .Values.schemaService.env.schemaServiceKey | quote }}
        {{- end }}
        # Trino Configuration
        - name: TRINO_HOST
          value: "{{ .Values.schemaService.env.trino.host }}"
        - name: TRINO_PORT
          value: "{{ .Values.schemaService.env.trino.port }}"
        - name: TRINO_CATALOG
          value: "{{ .Values.schemaService.env.trino.catalog }}"
        - name: TRINO_SCHEMA
          value: "{{ .Values.schemaService.env.trino.schema }}"
        - name: TRINO_USER
          valueFrom:
            secretKeyRef:
              name: {{ include "dashboard.fullname" . }}-trino-credentials
              key: username
        - name: TRINO_AUTH_USER
          valueFrom:
            secretKeyRef:
              name: {{ include "dashboard.fullname" . }}-trino-credentials
              key: username
        - name: TRINO_AUTH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "dashboard.fullname" . }}-trino-credentials
              key: password
        # PostgreSQL Configuration (for fetching table descriptions)
        - name: POSTGRES_HOST
          value: "{{ include "dashboard.fullname" . }}-postgres"
        - name: POSTGRES_PORT
          value: "5432"
        - name: POSTGRES_DB
          value: "{{ .Values.postgres.database }}"
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: {{ include "dashboard.fullname" . }}-postgres-credentials
              key: username
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "dashboard.fullname" . }}-postgres-credentials
              key: password
        - name: SCHEMA_REFRESH_HOURS
          value: "{{ .Values.schemaService.env.refreshHours }}"
        - name: INCLUDE_TPCH
          value: "{{ .Values.schemaService.env.includeTpch | default false }}"
        - name: TRINO_SSL_ENABLED
          value: "{{ .Values.schemaService.env.trino.ssl | default false }}"
        - name: TRINO_SSL_VERIFICATION
          value: "{{ .Values.schemaService.env.trino.sslVerification | default "NONE" }}"
        - name: SERVICE_HOST
          value: "0.0.0.0"
        - name: SERVICE_PORT
          value: "8001"
        - name: LOG_LEVEL
          value: "INFO"
        ports:
        - containerPort: 8001
          name: http
        volumeMounts:
        {{- if .Values.schemaService.storage.enabled }}
        - name: model-cache
          mountPath: /app/model_cache
        {{- end }}
        resources:
          {{- toYaml .Values.schemaService.resources | nindent 10 }}
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: {{ .Values.schemaService.probes.liveness.initialDelaySeconds }}
          periodSeconds: {{ .Values.schemaService.probes.liveness.periodSeconds }}
          timeoutSeconds: {{ .Values.schemaService.probes.liveness.timeoutSeconds }}
          failureThreshold: {{ .Values.schemaService.probes.liveness.failureThreshold }}
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: {{ .Values.schemaService.probes.readiness.initialDelaySeconds }}
          periodSeconds: {{ .Values.schemaService.probes.readiness.periodSeconds }}
          timeoutSeconds: {{ .Values.schemaService.probes.readiness.timeoutSeconds }}
          failureThreshold: {{ .Values.schemaService.probes.readiness.failureThreshold }}
      volumes:
      {{- if .Values.schemaService.storage.enabled }}
      - name: model-cache
        persistentVolumeClaim:
          claimName: {{ include "dashboard.fullname" . }}-schema-service-pvc
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "dashboard.fullname" . }}-schema-service
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "dashboard.labels" . | nindent 4 }}
    app.kubernetes.io/component: schema-service
spec:
  type: {{ .Values.schemaService.service.type }}
  ports:
  - port: {{ .Values.schemaService.service.port }}
    targetPort: http
    protocol: TCP
    name: http
  selector:
    {{- include "dashboard.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: schema-service
{{- end }}
