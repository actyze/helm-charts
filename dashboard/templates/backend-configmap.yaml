{{- if .Values.services.backend.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "dashboard.fullname" . }}-backend-config
  labels:
    {{- include "dashboard.labels" . | nindent 4 }}
data:
  application.yml: |
    # Dashboard Backend Configuration
    spring:
      application:
        name: dashboard-backend
      
      # Database Configuration
      datasource:
        url: jdbc:h2:mem:testdb
        driverClassName: org.h2.Driver
        username: sa
        password: password
      
      # JPA Configuration
      jpa:
        database-platform: org.hibernate.dialect.H2Dialect
        hibernate:
          ddl-auto: update
        show-sql: false
      
      # H2 Console (for development)
      h2:
        console:
          enabled: {{ .Values.global.environment | eq "development" }}
          path: /h2-console

    # Server Configuration
    server:
      port: 8080

    # Logging Configuration
    logging:
      level:
        com.dashboard: {{ .Values.logging.level.dashboard | default "INFO" }}
        com.dashboard.mcp: DEBUG
      pattern:
        console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
      file:
        name: {{ .Values.logging.files.application.path | default "/app/logs/dashboard-backend.log" }}

    # Dashboard Service Configuration
    dashboard:
      services:
        # Phi SQL LoRA Service
        phiSqlLora:
          url: {{ .Values.backend.env.phiSqlLora.url }}
          timeout: 30000
        
        # Schema Service
        schemaService:
          url: {{ .Values.backend.env.schemaService.url }}
          timeout: 10000
        
        # Trino Configuration (now handled via environment variables in deployment)
        trino:
          url: "jdbc:trino://{{ .Values.backend.env.trino.host }}:{{ .Values.backend.env.trino.port }}/{{ .Values.backend.env.trino.catalog }}/{{ .Values.backend.env.trino.schema }}?SSL=true&SSLVerification=NONE"
          user: "{{ .Values.backend.env.trino.user }}"

    # Management endpoints for health checks and metrics
    management:
      endpoints:
        web:
          exposure:
            include: health,ready,prometheus,metrics
      endpoint:
        health:
          show-details: always
        prometheus:
          enabled: {{ .Values.monitoring.metrics.enabled | default true }}
      metrics:
        export:
          prometheus:
            enabled: {{ .Values.monitoring.metrics.enabled | default true }}
{{- end }}
